name: Update Contributors
on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:
  push:
    branches: [ master ]    # ä¸»åˆ†æ”¯åç§°æ”¹ä¸º master

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # å¿…é¡»å¼€å¯å†™æƒé™

    steps:
      - uses: actions/checkout@v4
        with:
          ref: master      # æ˜ç¡®æŒ‡å®šæ£€å‡º master åˆ†æ”¯
          fetch-depth: 0   # è·å–å®Œæ•´æäº¤å†å²

      # ä½¿ç”¨ç¨³å®šç‰ˆè´¡çŒ®è€…ç”Ÿæˆå·¥å…·
      - name: Generate Contributors
        uses: contrib.rocks/preview@v2  # ä½¿ç”¨å›ºå®šç‰ˆæœ¬
        with:
          repo: hulutech-web/workflow-engine
          columns: 7
          image-size: 80
          font-size: 14
          template: table   # æ˜ç¡®æŒ‡å®šè¡¨æ ¼æ¨¡æ¿
          output-file: CONTRIBUTORS.md

      # å¯é çš„å†…å®¹æ›¿æ¢æ–¹æ¡ˆ
      - name: Update README
        run: |
          # æå–è´¡çŒ®è€…å†…å®¹ï¼ˆå…¼å®¹ macOS/linuxï¼‰
          CONTENT=$(sed -n '/<!-- START CONTRIBUTORS -->/,/<!-- END CONTRIBUTORS -->/{/<!--/d;p;}' CONTRIBUTORS.md)
          
          # æ›¿æ¢ README ä¸­çš„å ä½ç¬¦
          awk -v content="$CONTENT" '
            BEGIN {RS="<!-- CONTRIBUTORS-LIST:START -->[^>]*<!-- CONTRIBUTORS-LIST:END -->";ORS=""}
            {print $0 RT}
          ' RT="<!-- CONTRIBUTORS-LIST:START -->\n" content "\n<!-- CONTRIBUTORS-LIST:END -->" \
          README.md > tmp && mv tmp README.md

      # å¼ºåŒ–æäº¤é€»è¾‘
      - name: Commit changes
        run: |
          # é…ç½® Git èº«ä»½
          git config --global user.name "Workflow Bot"
          git config --global user.email "bot@hulutech.com"
          
          # æ£€æµ‹å˜æ›´å¹¶æäº¤
          git add README.md
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ”„ Auto-update contributors [skip ci]" --no-verify
            git pull --rebase origin master  # é˜²æ­¢å¹¶å‘å†²çª
            git push origin master
          else
            echo "No changes to commit"
          fi