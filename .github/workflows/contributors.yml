name: Update Contributors
on:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时运行一次（减少API调用频率）
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许工作流推送更改

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 使用更稳定的贡献者生成工具
      - name: Generate Contributors
        uses: jasonlong/contributors-script@v1
        with:
          repo: hulutech-web/workflow-engine
          columns: 7
          image-size: 80
          template: |
            <table>
              <tr>{{#contributors}}
                <td align="center">
                  <a href="{{html_url}}">
                    <img src="{{avatar_url}}" width="{{image-size}}px;" alt=""/>
                    <br/>
                    <sub><b>{{login}}</b></sub>
                  </a>
                </td>{{/contributors}}
              </tr>
            </table>

      # 更新README
      - name: Update README
        run: |
          # 将生成的CONTRIBUTORS.md内容插入到README
          awk -v new="$(cat CONTRIBUTORS.md)" '
            /<!-- CONTRIBUTORS-LIST:START -->/,/<!-- CONTRIBUTORS-LIST:END -->/ {
              if (/START/) {print; print new; next}
              if (/END/) next
            }
            {print}
          ' README.md > README.tmp && mv README.tmp README.md

      # 仅当有变化时提交
      - name: Commit changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "📌 Auto-update contributors" && git push)